package quantutil

import (
	"fmt"
	log "github.com/thinkboy/log4go"
	"github.com/vmihailenco/msgpack"
	"github.com/widuu/goini"
	hqbase "quant/hqmodule/base"
	redis "util/redis"
)

const (
	// QuantConfigFile is the configure file name for quant project
	QuantConfigFile string = "./conf/quant.ini"
	// QuantLogConfigFile is the log configure file name for quant project
	QuantLogConfigFile string = "./conf/quant_log.xml"
)

var (
	conf        = goini.SetConfig("./conf/quant.ini")
	redisconfig = map[string]string{
		"host":         conf.GetValue("redis", "redishost"),
		"database":     conf.GetValue("redis", "database"),
		"password":     conf.GetValue("redis", "password"),
		"maxOpenConns": conf.GetValue("redis", "maxOpenConns"),
		"maxIdleConns": conf.GetValue("redis", "maxIdleConns"),
	}
	redisPool *redis.ConnPool
)

func init() {
	redisPool = redis.InitRedis(redisconfig)
	_, err := redisPool.Do("PING")
	if err != nil {
		log.Error("redis error")
		panic(err)
	}
}

// Error struct is uesd for return error message
type Error struct {
	ErrorMsg string
}

func (e *Error) Error() string {
	return e.ErrorMsg
}

// GetQuote get maerket data from redis
func GetQuote(code string) (hqbase.Marketdata, error) {
	tmp, err := redisPool.GetBytes(code)
	
	if err != nil {
		return hqbase.Marketdata{}, &Error{fmt.Sprintf("Quant helper GetQuote error.\"%s\" ", err.Error())}
	}
	var mkdat hqbase.Marketdata
	err = msgpack.Unmarshal(tmp, &mkdat)
	if err != nil {
		return hqbase.Marketdata{}, &Error{fmt.Sprintf("Quant helper GetQuote error. \"%s\"", err.Error())}
	}
	return mkdat, nil
}
